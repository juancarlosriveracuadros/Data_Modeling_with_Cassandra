{
	"name": "DF_FACT_LOADING",
	"properties": {
		"folder": {
			"name": "CLEANSE_CORE"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_ALL_LAYER_STRUCTURE",
						"type": "DatasetReference"
					},
					"name": "coreFactSales"
				},
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_ALL_LAYER_STRUCTURE",
						"type": "DatasetReference"
					},
					"name": "coreDimKunde"
				},
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_ALL_LAYER_STRUCTURE",
						"type": "DatasetReference"
					},
					"name": "coreDimMaterial"
				},
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_ALL_LAYER_STRUCTURE",
						"type": "DatasetReference"
					},
					"name": "coreDimOrga"
				},
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_ALL_LAYER_STRUCTURE",
						"type": "DatasetReference"
					},
					"name": "coreDimDate"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_CORE_FACT_SALES",
						"type": "DatasetReference"
					},
					"name": "targetCoreFactSales"
				}
			],
			"transformations": [
				{
					"name": "setAttributes"
				},
				{
					"name": "lookupDimKunde"
				},
				{
					"name": "joinKundeOrig"
				},
				{
					"name": "selOrigData"
				},
				{
					"name": "selCol"
				},
				{
					"name": "addSk"
				},
				{
					"name": "aggAbsatz"
				},
				{
					"name": "lookupDimMaterial"
				},
				{
					"name": "calcDollarToEur"
				},
				{
					"name": "calcUmsatz"
				},
				{
					"name": "lookupDimDate"
				},
				{
					"name": "lookupDimOrga"
				},
				{
					"name": "AlterRow1"
				}
			],
			"script": "source(output(\n\t\tCSAL_FACT_SALES_SK as string,\n\t\tDIM_KUNDE_FK as string,\n\t\tDIM_AUFTRAG_FK as string,\n\t\tDIM_ORGA_FK as string,\n\t\tDIM_MATERIAL_FK as string,\n\t\tDIM_ZEIT_FK as string,\n\t\tCSAL_MANDT as string,\n\t\tCSAL_VBELN as string,\n\t\tCSAL_MATNR as string,\n\t\tCSAL_AUFNR as string,\n\t\tCSAL_KUNNR as string,\n\t\tCSAL_AWAHR as string,\n\t\tCSAL_BNAME as string,\n\t\tCSAL_VKORG as string,\n\t\tCSAL_VTWEG as string,\n\t\tCSAL_BUKRS_VF as string,\n\t\tCSAL_POSNR as string,\n\t\tCSAL_NETPR as string,\n\t\tCSAL_WAERK as string,\n\t\tCSAL_KWMENG as string,\n\t\tCSAL_UMSATZ as string,\n\t\tCSAL_BSTDK as string,\n\t\tCSAL_HASHKEY_BK as string,\n\t\tCSAL_HASHKEY_DATA as string,\n\t\tCSAL_CREATED_ON as string,\n\t\tCSAL_SOURCE as string,\n\t\tCSAL_VALID_FROM as string,\n\t\tCSAL_VALID_TO as string,\n\t\tCSAL_CURRENT_FLAG as string,\n\t\tCSAL_DML_STRAT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT * FROM CORE.FACT_SALES',\n\tformat: 'query') ~> coreFactSales\nsource(output(\n\t\tCKUN_DIM_KUNDE_SK as string,\n\t\tCKUN_MANDT as string,\n\t\tCKUN_KUNNR as string,\n\t\tCKUN_CURRENT_FLAG as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT CKUN_DIM_KUNDE_SK, CKUN_MANDT, CKUN_KUNNR, CKUN_CURRENT_FLAG FROM CORE.DIM_KUNDE',\n\tformat: 'query') ~> coreDimKunde\nsource(output(\n\t\tCMAT_DIM_MATERIAL_SK as string,\n\t\tCMAT_MANDT as string,\n\t\tCMAT_MATNR as string,\n\t\tCMAT_CURRENT_FLAG as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT CMAT_DIM_MATERIAL_SK, CMAT_MANDT, CMAT_MATNR, CMAT_CURRENT_FLAG FROM CORE.DIM_MATERIAL',\n\tformat: 'query') ~> coreDimMaterial\nsource(output(\n\t\tCORG_DIM_ORGA_SK as string,\n\t\tCORG_MANDT as string,\n\t\tCORG_VKORG as string,\n\t\tCORG_VTWEG as string,\n\t\tCORG_BUKRS as string,\n\t\tCORG_CURRENT_FLAG as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT CORG_DIM_ORGA_SK, CORG_MANDT, CORG_VKORG, CORG_VTWEG, CORG_BUKRS, CORG_CURRENT_FLAG FROM CORE.DIM_ORGA',\n\tformat: 'query') ~> coreDimOrga\nsource(output(\n\t\tDateKey as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT DateKey FROM Core.DIM_DATE',\n\tformat: 'query') ~> coreDimDate\ncoreFactSales derive(SOURCE = 'DIM_',\n\t\tDML_STRAT = 'INS',\n\t\tCREATED_ON = currentTimestamp(),\n\t\tCURRENT = 'Y',\n\t\tCSAL_KWMENG = toInteger(CSAL_KWMENG),\n\t\tCSAL_UMSATZ = toDouble(CSAL_UMSATZ),\n\t\tCSAL_NETPR = toDouble(CSAL_NETPR),\n\t\tDIM_ZEIT_FK = toInteger(DIM_ZEIT_FK),\n\t\tCSAL_VALID_FROM = toInteger(CSAL_BSTDK)) ~> setAttributes\nlookupDimMaterial, coreDimKunde lookup(CSAL_MANDT == CKUN_MANDT\n\t&& CSAL_KUNNR == CKUN_KUNNR\n\t&& CURRENT == CKUN_CURRENT_FLAG,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> lookupDimKunde\naggAbsatz, selOrigData join(aggAbsatz@CSAL_MANDT == selOrigData@CSAL_MANDT\n\t&& aggAbsatz@CSAL_KUNNR == selOrigData@CSAL_KUNNR\n\t&& aggAbsatz@CSAL_MATNR == selOrigData@CSAL_MATNR\n\t&& aggAbsatz@CSAL_BSTDK == selOrigData@CSAL_BSTDK,\n\tjoinType:'inner',\n\tbroadcast: 'auto')~> joinKundeOrig\nlookupDimKunde select(mapColumn(\n\t\teach(match(true()))\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selOrigData\ncalcUmsatz select(mapColumn(\n\t\tCSAL_MANDT = {aggAbsatz@CSAL_MANDT},\n\t\tCSAL_KUNNR = {aggAbsatz@CSAL_KUNNR},\n\t\tCSAL_MATNR = {aggAbsatz@CSAL_MATNR},\n\t\tCSAL_BSTDK = {aggAbsatz@CSAL_BSTDK},\n\t\tABSATZ,\n\t\tCSAL_FACT_SALES_SK,\n\t\tDIM_KUNDE_FK,\n\t\tDIM_AUFTRAG_FK,\n\t\tDIM_ORGA_FK,\n\t\tDIM_MATERIAL_FK,\n\t\tDIM_ZEIT_FK,\n\t\tCSAL_MANDT = {selOrigData@CSAL_MANDT},\n\t\tCSAL_VBELN,\n\t\tCSAL_MATNR = {selOrigData@CSAL_MATNR},\n\t\tCSAL_AUFNR,\n\t\tCSAL_KUNNR = {selOrigData@CSAL_KUNNR},\n\t\tCSAL_AWAHR,\n\t\tCSAL_BNAME,\n\t\tCSAL_VKORG,\n\t\tCSAL_VTWEG,\n\t\tCSAL_BUKRS_VF,\n\t\tCSAL_POSNR,\n\t\tCSAL_NETPR,\n\t\tCSAL_WAERK,\n\t\tCSAL_KWMENG,\n\t\tCSAL_UMSATZ,\n\t\tCSAL_BSTDK = {selOrigData@CSAL_BSTDK},\n\t\tCSAL_HASHKEY_BK,\n\t\tCSAL_HASHKEY_DATA,\n\t\tCSAL_CREATED_ON,\n\t\tCSAL_SOURCE,\n\t\tCSAL_VALID_FROM,\n\t\tCSAL_VALID_TO,\n\t\tCSAL_CURRENT_FLAG,\n\t\tCSAL_DML_STRAT,\n\t\tSOURCE,\n\t\tDML_STRAT,\n\t\tCREATED_ON,\n\t\tCURRENT,\n\t\tDateKey,\n\t\tCORG_DIM_ORGA_SK,\n\t\tCORG_MANDT,\n\t\tCORG_VKORG,\n\t\tCORG_VTWEG,\n\t\tCORG_BUKRS,\n\t\tCORG_CURRENT_FLAG,\n\t\tCMAT_DIM_MATERIAL_SK,\n\t\tCMAT_MANDT,\n\t\tCMAT_MATNR,\n\t\tCMAT_CURRENT_FLAG,\n\t\tCKUN_DIM_KUNDE_SK,\n\t\tCKUN_MANDT,\n\t\tCKUN_KUNNR,\n\t\tCKUN_CURRENT_FLAG,\n\t\tUMSATZ\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> selCol\nselCol keyGenerate(output(NEWSK as long),\n\tstartAt: 1L) ~> addSk\nlookupDimKunde aggregate(groupBy(CSAL_MANDT,\n\t\tCSAL_KUNNR,\n\t\tCSAL_MATNR,\n\t\tCSAL_BSTDK),\n\tABSATZ = sum(CSAL_KWMENG)) ~> aggAbsatz\nlookupDimOrga, coreDimMaterial lookup(CSAL_MANDT == CMAT_MANDT\n\t&& CSAL_MATNR == CMAT_MATNR\n\t&& CURRENT == CMAT_CURRENT_FLAG,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> lookupDimMaterial\njoinKundeOrig derive(CSAL_NETPR = iif(CSAL_WAERK == 'EUR', toDouble(CSAL_NETPR),round(toDouble(CSAL_NETPR * 0.9),2) )) ~> calcDollarToEur\ncalcDollarToEur derive(UMSATZ = round(CSAL_NETPR * CSAL_KWMENG,2)) ~> calcUmsatz\nsetAttributes, coreDimDate lookup(toInteger(CSAL_BSTDK) == DateKey,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> lookupDimDate\nlookupDimDate, coreDimOrga lookup(CSAL_MANDT == CORG_MANDT\n\t&& CSAL_VKORG == CORG_VKORG\n\t&& CSAL_VTWEG == CORG_VTWEG\n\t&& CSAL_BUKRS_VF == CORG_BUKRS\n\t&& CURRENT == CORG_CURRENT_FLAG,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> lookupDimOrga\naddSk alterRow(updateIf(true())) ~> AlterRow1\nAlterRow1 sink(input(\n\t\tCSAL_FACT_SALES_SK as string,\n\t\tDIM_KUNDE_FK as string,\n\t\tDIM_AUFTRAG_FK as string,\n\t\tDIM_ORGA_FK as string,\n\t\tDIM_MATERIAL_FK as string,\n\t\tDIM_ZEIT_FK as string,\n\t\tCSAL_MANDT as string,\n\t\tCSAL_VBELN as string,\n\t\tCSAL_MATNR as string,\n\t\tCSAL_AUFNR as string,\n\t\tCSAL_KUNNR as string,\n\t\tCSAL_AWAHR as string,\n\t\tCSAL_BNAME as string,\n\t\tCSAL_VKORG as string,\n\t\tCSAL_VTWEG as string,\n\t\tCSAL_BUKRS_VF as string,\n\t\tCSAL_POSNR as string,\n\t\tCSAL_NETPR as string,\n\t\tCSAL_WAERK as string,\n\t\tCSAL_KWMENG as string,\n\t\tCSAL_UMSATZ as string,\n\t\tCSAL_BSTDK as string,\n\t\tCSAL_HASHKEY_BK as string,\n\t\tCSAL_HASHKEY_DATA as string,\n\t\tCSAL_CREATED_ON as string,\n\t\tCSAL_SOURCE as string,\n\t\tCSAL_VALID_FROM as string,\n\t\tCSAL_VALID_TO as string,\n\t\tCSAL_CURRENT_FLAG as string,\n\t\tCSAL_DML_STRAT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['CSAL_HASHKEY_BK','CSAL_HASHKEY_DATA'],\n\tformat: 'table',\n\tbatchSize: 50,\n\tpreSQLs:['\\n'],\n\tmapColumn(\n\t\tCSAL_FACT_SALES_SK = NEWSK,\n\t\tDIM_KUNDE_FK = CKUN_DIM_KUNDE_SK,\n\t\tDIM_ORGA_FK = CORG_DIM_ORGA_SK,\n\t\tDIM_ZEIT_FK = CSAL_BSTDK,\n\t\tDIM_MATERIAL_FK = CMAT_DIM_MATERIAL_SK,\n\t\tCSAL_MANDT,\n\t\tCSAL_VBELN,\n\t\tCSAL_MATNR,\n\t\tCSAL_AUFNR,\n\t\tCSAL_KUNNR,\n\t\tCSAL_AWAHR,\n\t\tCSAL_BNAME,\n\t\tCSAL_VKORG,\n\t\tCSAL_VTWEG,\n\t\tCSAL_POSNR,\n\t\tCSAL_NETPR,\n\t\tCSAL_WAERK,\n\t\tCSAL_KWMENG = ABSATZ,\n\t\tCSAL_UMSATZ = UMSATZ,\n\t\tCSAL_BSTDK = CSAL_VALID_FROM,\n\t\tCSAL_HASHKEY_BK,\n\t\tCSAL_HASHKEY_DATA,\n\t\tCSAL_CREATED_ON,\n\t\tCSAL_SOURCE = SOURCE,\n\t\tCSAL_VALID_FROM,\n\t\tCSAL_VALID_TO,\n\t\tCSAL_CURRENT_FLAG = CURRENT,\n\t\tCSAL_DML_STRAT = DML_STRAT\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> targetCoreFactSales"
		}
	}
}