{
	"name": "DF_CLEANSE_CORE_FACT_SALES_SCD",
	"properties": {
		"folder": {
			"name": "CLEANSE_CORE"
		},
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_ALL_LAYER_STRUCTURE",
						"type": "DatasetReference"
					},
					"name": "SourceCleanseSales"
				},
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_ALL_LAYER_STRUCTURE",
						"type": "DatasetReference"
					},
					"name": "SourceCoreSales"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "SRC_AZRSQL_CORE_FACT_SALES",
						"type": "DatasetReference"
					},
					"name": "targetUpdateCoreFactSales"
				},
				{
					"dataset": {
						"referenceName": "TRG_AZRSQL_CORE_FACT_SALES_TEMP",
						"type": "DatasetReference"
					},
					"name": "targetInsertCoreFactSales"
				}
			],
			"transformations": [
				{
					"name": "CoreDimSalesMaxSk"
				},
				{
					"name": "Lookup"
				},
				{
					"name": "ConditionalSplit1"
				},
				{
					"name": "derivedColForUpdatedRow"
				},
				{
					"name": "alterRowforUpdate"
				},
				{
					"name": "createSk"
				},
				{
					"name": "joinOnMaxKey"
				},
				{
					"name": "derivedColForNewRows"
				},
				{
					"name": "AlterRow1"
				},
				{
					"name": "filterActiceRows"
				}
			],
			"script": "source(output(\n\t\tMANDT as integer,\n\t\tVBELN as string,\n\t\tMATNR as string,\n\t\tAUFNR as integer,\n\t\tKUNNR as string,\n\t\tAWAHR as integer,\n\t\tBNAME as string,\n\t\tVKORG as string,\n\t\tVTWEG as string,\n\t\tBUKRS_VF as string,\n\t\tPOSNR as integer,\n\t\tNETPR as float,\n\t\tWAERK as string,\n\t\tKWMENG as integer,\n\t\tBSTDK as integer,\n\t\tHASHKEY_BK as string,\n\t\tHASHKEY_DATA as string,\n\t\tCREATED_ON as timestamp,\n\t\tSOURCE as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT * FROM CLEANSE.SALES',\n\tformat: 'query') ~> SourceCleanseSales\nsource(output(\n\t\tCSAL_FACT_SALES_SK as string,\n\t\tCSAL_MANDT as string,\n\t\tCSAL_VBELN as string,\n\t\tCSAL_MATNR as string,\n\t\tCSAL_AUFNR as string,\n\t\tCSAL_KUNNR as string,\n\t\tCSAL_AWAHR as string,\n\t\tCSAL_BNAME as string,\n\t\tCSAL_VKORG as string,\n\t\tCSAL_VKGRP as string,\n\t\tCSAL_VTWEG as string,\n\t\tCSAL_POSNR as string,\n\t\tCSAL_NETPR as string,\n\t\tCSAL_WAERK as string,\n\t\tCSAL_KWMENG as string,\n\t\tCSAL_BSTDK as string,\n\t\tCSAL_VDATU as string,\n\t\tCSAL_HASHKEY_BK as string,\n\t\tCSAL_HASHKEY_DATA as string,\n\t\tCSAL_CREATED_ON as string,\n\t\tCSAL_SOURCE as string,\n\t\tCSAL_VALID_FROM as string,\n\t\tCSAL_VALID_TO as string,\n\t\tCSAL_CURRENT_FLAG as string,\n\t\tCSAL_DML_STRAT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tquery: 'SELECT * FROM CORE.FACT_SALES',\n\tformat: 'query') ~> SourceCoreSales\nfilterActiceRows aggregate(MAXSK = max(toInteger(CSAL_FACT_SALES_SK))) ~> CoreDimSalesMaxSk\nSourceCleanseSales, filterActiceRows lookup(MANDT == toInteger(CSAL_MANDT)\n\t&& VBELN == CSAL_VBELN,\n\tmultiple: false,\n\tpickup: 'any',\n\tbroadcast: 'auto')~> Lookup\nLookup split(!isNull(CSAL_HASHKEY_BK) && notEquals(CSAL_HASHKEY_DATA, HASHKEY_DATA),\n\tisNull(CSAL_HASHKEY_BK),\n\tdisjoint: false) ~> ConditionalSplit1@(updateRows, newRows, doNothing)\nConditionalSplit1@updateRows derive(CURRENT_FLAG = 'N',\n\t\tVALID_TO = currentTimestamp(),\n\t\tDML_STRAT = 'HIST_UPD') ~> derivedColForUpdatedRow\nderivedColForUpdatedRow alterRow(updateIf(true())) ~> alterRowforUpdate\nConditionalSplit1@newRows keyGenerate(output(SK as long),\n\tstartAt: 1L) ~> createSk\ncreateSk, CoreDimSalesMaxSk join(SK == MAXSK || true(),\n\tjoinType:'cross',\n\tbroadcast: 'auto')~> joinOnMaxKey\njoinOnMaxKey derive(NEWSK = SK + MAXSK,\n\t\tVALID_FROM = currentTimestamp(),\n\t\tVALID_TO = toTimestamp('2999-12-31 00:00:00'),\n\t\tDML_STRAT = iif(notEquals(CSAL_HASHKEY_DATA, HASHKEY_DATA), 'HIST_INS', 'INS'),\n\t\tSOURCE = 'CLEANSE.SALES',\n\t\tCREATED_ON = currentTimestamp(),\n\t\tCURRENT_FLAG = 'Y') ~> derivedColForNewRows\nderivedColForNewRows alterRow(insertIf(true())) ~> AlterRow1\nSourceCoreSales filter(CSAL_CURRENT_FLAG == 'Y') ~> filterActiceRows\nalterRowforUpdate sink(input(\n\t\tCSAL_FACT_SALES_SK as string,\n\t\tDIM_KUNDE_FK as string,\n\t\tDIM_AUFTRAG_FK as string,\n\t\tDIM_ORGA_FK as string,\n\t\tDIM_MATERIAL_FK as string,\n\t\tDIM_ZEIT_FK as string,\n\t\tCSAL_MANDT as string,\n\t\tCSAL_VBELN as string,\n\t\tCSAL_MATNR as string,\n\t\tCSAL_AUFNR as string,\n\t\tCSAL_KUNNR as string,\n\t\tCSAL_AWAHR as string,\n\t\tCSAL_BNAME as string,\n\t\tCSAL_VKORG as string,\n\t\tCSAL_VTWEG as string,\n\t\tCSAL_BUKRS_VF as string,\n\t\tCSAL_POSNR as string,\n\t\tCSAL_NETPR as string,\n\t\tCSAL_WAERK as string,\n\t\tCSAL_KWMENG as string,\n\t\tCSAL_UMSATZ as string,\n\t\tCSAL_BSTDK as string,\n\t\tCSAL_HASHKEY_BK as string,\n\t\tCSAL_HASHKEY_DATA as string,\n\t\tCSAL_CREATED_ON as string,\n\t\tCSAL_SOURCE as string,\n\t\tCSAL_VALID_FROM as string,\n\t\tCSAL_VALID_TO as string,\n\t\tCSAL_CURRENT_FLAG as string,\n\t\tCSAL_DML_STRAT as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:false,\n\tupdateable:true,\n\tupsertable:false,\n\tkeys:['CSAL_FACT_SALES_SK'],\n\tformat: 'table',\n\tmapColumn(\n\t\tCSAL_FACT_SALES_SK,\n\t\tCSAL_VALID_TO = VALID_TO,\n\t\tCSAL_CURRENT_FLAG = CURRENT_FLAG,\n\t\tCSAL_DML_STRAT = DML_STRAT\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> targetUpdateCoreFactSales\nAlterRow1 sink(allowSchemaDrift: true,\n\tvalidateSchema: false,\n\tdeletable:false,\n\tinsertable:true,\n\tupdateable:false,\n\tupsertable:false,\n\tformat: 'table',\n\tmapColumn(\n\t\tCSAL_MANDT = MANDT,\n\t\tCSAL_VBELN = VBELN,\n\t\tCSAL_MATNR = MATNR,\n\t\tCSAL_AUFNR = AUFNR,\n\t\tCSAL_KUNNR = KUNNR,\n\t\tCSAL_AWAHR = AWAHR,\n\t\tCSAL_BNAME = BNAME,\n\t\tCSAL_VKORG = VKORG,\n\t\tCSAL_VTWEG = VTWEG,\n\t\tCSAL_BUKRS_VF = BUKRS_VF,\n\t\tCSAL_POSNR = POSNR,\n\t\tCSAL_NETPR = NETPR,\n\t\tCSAL_WAERK = WAERK,\n\t\tCSAL_KWMENG = KWMENG,\n\t\tCSAL_BSTDK = BSTDK,\n\t\tCSAL_HASHKEY_BK = HASHKEY_BK,\n\t\tCSAL_HASHKEY_DATA = HASHKEY_DATA,\n\t\tCSAL_CREATED_ON = CREATED_ON,\n\t\tCSAL_SOURCE = SOURCE,\n\t\tCSAL_VALID_FROM = VALID_FROM,\n\t\tCSAL_VALID_TO = VALID_TO,\n\t\tCSAL_CURRENT_FLAG = CURRENT_FLAG,\n\t\tCSAL_DML_STRAT = DML_STRAT\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> targetInsertCoreFactSales"
		}
	}
}